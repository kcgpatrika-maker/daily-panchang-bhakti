<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Ask Bhakti — Bhakti Panchang</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .btn { margin: 4px; padding: 8px 12px; cursor: pointer; }
    .section { margin: 16px 0; }
    .hidden { display: none; }
    h2 { margin: 8px 0; }
    h3 { margin: 8px 0; }
    h4 { margin: 6px 0; }
    p { margin: 4px 0; }
  </style>
</head>
<body>

  <h1>देवी-देवता से पूछें</h1>

  <!-- देवता buttons -->
  <div id="devta-buttons"></div>

  <!-- Loading -->
  <p id="loading" class="hidden">लोड हो रहा है...</p>

  <!-- Error -->
  <p id="error" class="hidden"></p>

  <!-- Bhakti content -->
  <div id="content" class="hidden">
    <h2 id="name"></h2>

    <div id="mantra" class="section"></div>
    <div id="aarti" class="section"></div>
    <div id="pujaVidhi" class="section"></div>
    <div id="chalisa" class="section"></div>
    <div id="stotra" class="section"></div>
  </div>

<script>
/* ---------------------------------------------
   Config
--------------------------------------------- */
const DEVTA_LIST = [
  { key: "hanuman", label: "हनुमान जी" },
  { key: "shiv", label: "शिव जी" },
  { key: "durga", label: "माँ दुर्गा" },
  { key: "krishna", label: "श्री कृष्ण" },
  { key: "ganesh", label: "गणेश जी" }
];

// same origin के लिए खाली रखें; अलग backend हो तो origin डालें
const backend = ""; 

/* ---------------------------------------------
   Helpers
--------------------------------------------- */
function hide(el) { el.classList.add("hidden"); }
function show(el) { el.classList.remove("hidden"); }

function initButtons() {
  const container = document.getElementById("devta-buttons");
  DEVTA_LIST.forEach(d => {
    const btn = document.createElement("button");
    btn.textContent = d.label;
    btn.className = "btn";
    btn.onclick = () => fetchData(d.key);
    container.appendChild(btn);
  });
}

async function fetchData(devta) {
  hide(document.getElementById("error"));
  show(document.getElementById("loading"));
  hide(document.getElementById("content"));

  try {
    // सही API: query parameter
    const res = await fetch(`${backend}/api/ask-bhakti?deity=${encodeURIComponent(devta)}`);
    const json = await res.json();

    // बैकएंड सीधे { deity, available, content } देता है
    if (!json || !json.content) throw new Error("Data not found");

    renderContent(json);
  } catch (e) {
    document.getElementById("error").textContent = "जानकारी लोड नहीं हो पाई";
    show(document.getElementById("error"));
  } finally {
    hide(document.getElementById("loading"));
  }
}

/* ---------------------------------------------
   Render
--------------------------------------------- */
function renderContent(d) {
  document.getElementById("name").textContent = d.deity || "";

  fillSimpleSection("mantra", "मंत्र", d.content.mantra);
  fillAartiSection("aarti", "आरती", d.content.aarti);
  fillSimpleSection("pujaVidhi", "पूजा विधि", normalizeToLines(d.content.poojaVidhi));
  fillSimpleSection("chalisa", "चालीसा", normalizeToLines(d.content.chalisa));
  fillSimpleSection("stotra", "स्तोत्र", d.content.stotra);

  show(document.getElementById("content"));
}

/* ---------------------------------------------
   Normalizers
--------------------------------------------- */
// किसी भी value को lines array में बदलें (string/array/empty)
function normalizeToLines(value) {
  if (!value) return [];
  if (Array.isArray(value)) {
    return value
      .map(v => (typeof v === "string" ? v.trim() : ""))
      .filter(v => v.length > 0);
  }
  if (typeof value === "string") {
    return value
      .split("\n")
      .map(v => v.trim())
      .filter(v => v.length > 0);
  }
  return [];
}

// आरती items को एकसमान बनाएं: [{ title, aarti:[lines] }]
function normalizeAartiItems(arr) {
  if (!Array.isArray(arr)) return [];
  return arr.map(item => {
    // item object हो सकता है या string/array—सबको normalize करें
    if (typeof item === "string") {
      // सिर्फ़ title मिला—lines नहीं; title दिखाएँ, lines खाली
      return { title: item.trim(), aarti: [] };
    }
    if (Array.isArray(item)) {
      // सीधे lines मिलीं—title नहीं
      return { title: "", aarti: normalizeToLines(item) };
    }
    // object case
    const title = typeof item?.title === "string" ? item.title.trim() : "";
    const lines = normalizeToLines(item?.aarti);
    return { title, aarti: lines };
  });
}

/* ---------------------------------------------
   Sections
--------------------------------------------- */
// साधारण सेक्शन: lines array
function fillSimpleSection(id, title, arr) {
  const sec = document.getElementById(id);
  sec.innerHTML = "";
  const lines = normalizeToLines(arr);
  if (!lines.length) return;

  const h3 = document.createElement("h3");
  h3.textContent = title;
  sec.appendChild(h3);

  lines.forEach(line => {
    const p = document.createElement("p");
    p.textContent = line;
    sec.appendChild(p);
  });
}

// आरती सेक्शन: objects array [{title, aarti:[...]}]
function fillAartiSection(id, title, arr) {
  const sec = document.getElementById(id);
  sec.innerHTML = "";

  const items = normalizeAartiItems(arr);
  if (!items.length) return;

  const h3 = document.createElement("h3");
  h3.textContent = title;
  sec.appendChild(h3);

  items.forEach(item => {
    // Title (अगर है)
    if (item.title) {
      const h4 = document.createElement("h4");
      h4.textContent = item.title;
      sec.appendChild(h4);
    }
    // Lines (अगर हैं)
    if (Array.isArray(item.aarti) && item.aarti.length) {
      item.aarti.forEach(line => {
        const p = document.createElement("p");
        p.textContent = line;
        sec.appendChild(p);
      });
    }
  });
}

/* ---------------------------------------------
   Boot
--------------------------------------------- */
initButtons();
</script>

</body>
</html>
